<link rel="stylesheet" href="~/css/Header.css" asp-append-version="true" />


<div class="header">
    <a asp-controller="Home" asp-action="Index">
        <img id="imgLogo" src="~/imgs/Logos/Logo.svg" alt="Logo" />
    </a>


    <div class="navigation">
        <a class="navi-item" asp-area="" asp-controller="Produto" asp-action="Catalogo">Produtos</a>
        <a class="navi-item" asp-area="" asp-controller="Home" asp-action="Index" asp-fragment="lancamentos" style="scroll-behavior: smooth;">Lançamentos</a>

    </div>

    <form class="bar-Pesquisa" method="get" action="/Produto/Catalogo">
        <img class="lupa" src="~/imgs/lupa.png" alt="Icone lupa" />
        <input id="HeaderBusca" name="search" type="text" class="text-Pesquisa" placeholder="Pesquise pelos produtos..." value="@ViewBag.Search" />
    </form>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const campoBusca = document.querySelector('input[name="search"]') || document.getElementById('HeaderBusca');
            const formulario = campoBusca ? campoBusca.closest('form') : null;
            if (!campoBusca || !formulario) return;

            let temporizador = null;
            let compondo = false;
            let ultimoValor = (campoBusca.value || '').trim();
            let ultimoEnviado = ultimoValor;

            
            campoBusca.addEventListener('compositionstart', () => compondo = true);
            campoBusca.addEventListener('compositionend', () => {
                compondo = false;
                
                handleInput();
            });

            campoBusca.addEventListener('input', handleInput);

            function handleInput() {
                if (compondo) return;
                const valor = (campoBusca.value || '').trim();
                if (valor === ultimoValor) return;
                ultimoValor = valor;
            }

            function enviarFormularioSeNecessario() {
                // evita envios repetidos com mesmo valor
                if (ultimoValor === ultimoEnviado) return;
                enviarFormulario();
            }

            function enviarFormulario() {
                clearTimeout(temporizador);
                // marca último enviado antes de enviar
                ultimoEnviado = ultimoValor;
                if (typeof formulario.requestSubmit === 'function') {
                    formulario.requestSubmit();
                } else {
                    formulario.submit();
                }
            }

            // ao clicar fora do campo vai enviar a pesquisa
            document.addEventListener('click', function (ev) {
                // se clicou dentro do input ou dentro do form, não envia
                if (ev.target.closest && (ev.target.closest('form') === formulario)) return;
                if (compondo) return;
                // só enviar se houve mudança desde o último envio
                if (ultimoValor !== ultimoEnviado) {
                    enviarFormulario();
                }
            });

            // Ao enviar atualiza últimoEnviado para evitar reenvio
            formulario.addEventListener('submit', function () {
                ultimoEnviado = ultimoValor;
                clearTimeout(temporizador);
            });

            // opcional: ao carregar a página, atualiza estados locais
            window.addEventListener('load', function () {
                ultimoValor = (campoBusca.value || '').trim();
                ultimoEnviado = ultimoValor;
            });
        });
    </script>


    <div class="menuUsr">
        <a asp-controller="Carrinho" asp-action="Index"><img class="menuUsr-img" src="~/imgs/carrinho.png" id="carrinho" alt="Carrinho"/></a>
        <img class="menuUsr-img" src="~/imgs/person.png" id="perfil">
        <script>
            document.getElementById('perfil').addEventListener('click', () => {
                // Faz uma requisição para verificar sessão e nível de acesso
                fetch('/Usuario/VerificarAcesso')
                    .then(r => r.json())
                    .then(res => {
                        if (!res.authenticated) {
                            window.location.href = '/Login';
                            return;
                        }
                        // redireciona conforme o servidor indicou
                        if (res.redirect) {
                            window.location.href = res.redirect;
                        } else {
                            window.location.href = '/Usuario/Perfil';
                        }
                    })
                    .catch(err => {
                        console.error('Erro ao verificar acesso:', err);
                        window.location.href = '/Login';
                    });
            });
        </script>

    </div>

</div>