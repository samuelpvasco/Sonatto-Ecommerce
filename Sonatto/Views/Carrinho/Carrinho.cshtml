@model Sonatto.Models.CarrinhoViewModel?
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carrinho - Sonatto</title>

    <link rel="stylesheet" href="~/css/Index.css" />
    <link rel="stylesheet" href="~/css/Carrinho.css" />
    <link rel="shortcut icon" href="~/imgs/Logos/Monografia.png" />
    <link href="https://fonts.googleapis.com/css2?family=Bruno+Ace&display=swap" rel="stylesheet">
</head>

<body>

    @Html.Partial("_Header")

    <div class="breadcrumb">
        <a asp-controller="Home" asp-action="Index">Início ></a>
        <a asp-controller="Carrinho" asp-action="Index" class="active">Carrinho</a>
    </div>

    <h1 class="tituloCarrinho">Seu Carrinho</h1>

    <div class="carrinhoContainer" id="carrinho-container" data-id-usuario="@ViewBag.UsuarioId">
        @* Lista de itens do carrinho *@
        <div class="carrinhoLista" id="lista-itens">

            @if (Model?.Items?.Any() == true)
            {
                foreach (var item in Model.Items)
                {
                    var imagem = string.IsNullOrEmpty(item.ProdutoImagemUrl)
                    ? Url.Content("~/imgs/Produto/Bateria1.jpg")
                    : Url.Content(item.ProdutoImagemUrl);

                    <div class="itemCarrinho"
                         data-id-item="@item.IdItemCarrinho"
                         data-id-produto="@item.IdProduto"
                         data-id-carrinho="@item.IdCarrinho">

                        <img class="itemImg" src="@imagem" />

                        <div class="itemInfo">
                            <h3 class="itemNome">@item.ProdutoNome</h3>
                            <p class="itemPreco">@item.PrecoUnidadeCar.ToString("C", new System.Globalization.CultureInfo("pt-BR"))</p>
                        </div>

                        <img class="itemDelete" src="~/imgs/Icones/trash.svg" />

                        <div class="itemQuantidade">
                            <button class="quantBtn diminuir">-</button>
                            <span class="qtd">@item.QtdItemCar</span>
                            <button class="quantBtn aumentar">+</button>
                        </div>
                    </div>
                }
            }
            else
            {
                <div id="msg-vazio">Seu carrinho está vazio.</div>
            }

        </div>
        @* Dados do carrinho *@
        <div class="resumoCarrinho">
            <h2>Detalhes Pedido</h2>

            <div class="resumoLinha">
                <span>Subtotal</span>
                <p id="subtotal">R$ 0,00</p>
            </div>

            <div class="resumoLinha">
                <span>Frete</span>
                <p id="frete">R$ 15,00</p>
            </div>

            <hr />

            <div class="resumoTotal">
                <span>Total</span>
                <p id="total">R$ 0,00</p>
            </div>

            <button id="btn-finalizar" class="btnFinalizar">Finalizar Compra →</button>
        </div>

        @* Mensagem de finalizar compra *@
        <div></div>
        @* Modal de finalização *@
        <div id="modal-finalizar" class="modal">
            <div class="modal-card">
                <div class="conteudo-modal">
                    <h3 style="color:#222; font-size:25px; font-family:'Bruno Ace'; font-weight:700">Finalizar Compra</h3>
                    <p style="font-size:18px;">Revise as informações e escolha a forma de pagamento.</p>

                    <div class="modal-linhas">
                        <label style="font-family:Source Code Pro">Forma de pagamento</label>
                        <select id="tipo-pagamento" class="input-venda">
                            <option value="PIX">Pix</option>
                            <option value="CREDITO">Crédito</option>
                            <option value="DEBITO">Débito</option>
                        </select>
                    </div>

                    <div class="modal-linhas2">
                        <label style="font-family:Source Code Pro">Observações (opcional)</label>
                        <textarea id="observacoes" class="input-venda" rows="3" placeholder="Instruções para entrega, trocas..."></textarea>
                    </div>

                    <div class="modal-botoes">
                        <button id="modal-cancel" class="btn-cancel">Cancelar</button>
                        <button id="modal-submit" class="btn-confirm">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @Html.Partial("_Footer")

    @* Modal de cartão*@
    <div id="modal-cartao" class="modal-cartao" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="card-card" role="document">
            <div class="card-title">Dados do cartão</div>

            <div id="card-error" class="card-error" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="icon">!</div>
                <div id="card-error-text">Preencha corretamente os dados do cartão.</div>
            </div>

            <label>Número do Cartão</label>
            <input id="cartao-num" class="card-input" placeholder="0000 0000 0000 0000" maxlength="23" />

            <label>Nome do Titular</label>
            <input id="cartao-nome" class="card-input" placeholder="Nome como no cartão" />

            <div class="card-row">
                <div style="display:flex; gap:12px; align-items:center; flex:1;">
                    <div style="display:flex; flex-direction:column;">
                        <label>CVV</label>
                        <input id="cartao-cvv" class="card-small" placeholder="123" maxlength="4" />
                    </div>

                    <div style="display:flex; flex-direction:column;">
                        <label>Validade</label>
                        <input id="cartao-validade" class="card-small" placeholder="MM/AA" maxlength="5" />
                    </div>
                </div>

                <div style="display:flex; align-items:center;">
                    <div class="brands" aria-hidden="true">
                        <img id="brand-visa" src="~/imgs/Icones/visa.png" alt="Visa" />
                        <img id="brand-elo" src="~/imgs/Icones/elo.png" alt="Elo" />
                        <img id="brand-master" src="~/imgs/Icones/mastercard.png" alt="Mastercard" />
                    </div>
                </div>
            </div>
                
            <div class="card-actions">
                <button id="cartao-finalizar" class="btnFinalizar--modal">Finalizar Compra →</button>
            </div>
        </div>
    </div>

    @* Modal PIX *@
    <div id="modal-pix" class="modal-pix" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="pix-card" role="document">
            <div class="pix-header">
                <div class="pix-title">PAGAMENTO POR PIX</div>
            </div>

            <div class="pix-body">
                <div class="pix-qr">
                    <img id="pix-qr-img" src="/imgs/QRCode/placeholder.png" alt="QR Pix" />
                </div>

                <div class="pix-info">
                    <div><strong>Chave Pix:</strong></div>
                    <div id="pix-key" class="pix-key">gerando-chave-pix...</div>

                    <div id="pix-countdown" class="pix-countdown" style="display:none">Aguardando pagamento — 00:20</div>
                    <div id="pix-processing" class="pix-processing" style="display:none"><div class="spinner" aria-hidden="true"></div> <div class="processing-title">PROCESSANDO COMPRA</div></div>
                    <div id="pix-completed" class="pix-completed" style="display:none">COMPRA FINALIZADA</div>

                    
                    <div id="pix-details" style="margin-top:8px;"></div>

                    <div class="pix-actions" style="margin-top:10px;">
                        <button id="pix-copy" class="btn-copy">Copiar chave</button>
                        <button id="pix-open" class="btn-copy">Abrir no app</button>
                    </div>

                    <div class="pix-note">Escaneie o QR ou copie a chave no seu app bancário. Ao tocar em "Finalizar Compra" o pagamento será processado e então confirmará a compra.</div>
                </div>
            </div>

            <div style="width:100%; display:flex; justify-content:center; margin-top:8px;">
                <button id="pix-finalizar" class="btn-finalize">Finalizar Compra</button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

    @* Script para buscar carrinho e itens e abrir modal *@
    <script>
        (() => {
            const container = document.getElementById("carrinho-container");
            if (!container) return;

            const idUsuario = container.dataset.idUsuario;
            const listaItens = document.getElementById("lista-itens");

            const campoSubtotal = document.getElementById("subtotal");
            const campoFrete = document.getElementById("frete");
            const campoTotal = document.getElementById("total");

            const btnFinalizar = document.getElementById('btn-finalizar');
            const modal = document.getElementById('modal-finalizar');
            const modalCancel = document.getElementById('modal-cancel');
            const modalSubmit = document.getElementById('modal-submit');
            const tipoPagamentoEl = document.getElementById('tipo-pagamento');
            const obsEl = document.getElementById('observacoes');

            // elementos do modal de cartão
            const modalCartao = document.getElementById('modal-cartao');
            const cartaoNome = document.getElementById('cartao-nome');
            const cartaoNum = document.getElementById('cartao-num');
            const cartaoVal = document.getElementById('cartao-validade');
            const cartaoCvv = document.getElementById('cartao-cvv');
            const cartaoFinalizar = document.getElementById('cartao-finalizar');

            const brandVisa = document.getElementById('brand-visa');
            const brandElo = document.getElementById('brand-elo');
            const brandMaster = document.getElementById('brand-master');

            // usar let para permitir recriação dinâmica se elemento não existir no momento da captura
            let toast = document.getElementById('toast');

            // PIX modal elements
            const modalPix = document.getElementById('modal-pix');
            const pixCard = modalPix?.querySelector('.pix-card');
            const pixQrImg = document.getElementById('pix-qr-img');
            const pixKeyEl = document.getElementById('pix-key');
            const pixCopyBtn = document.getElementById('pix-copy');
            const pixOpenBtn = document.getElementById('pix-open');
            const pixFinalizar = document.getElementById('pix-finalizar');

            const pixCountdownEl = document.getElementById('pix-countdown');
            const pixProcessingEl = document.getElementById('pix-processing');
            const pixCompletedEl = document.getElementById('pix-completed');
            const pixDetailsEl = document.getElementById('pix-details');

            const cardError = document.getElementById('card-error');
            const cardErrorText = document.getElementById('card-error-text');

            let currentCarrinhoId = null;

            const freteValor = 15;

            const formatarValor = valor =>
                new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(valor);

            const corrigirImagem = url =>
                !url ? "/imgs/Produto/Bateria1.jpg" : url.replace(/^~\//, "/");

            const criarItemHtml = item => `
                <div class="itemCarrinho"
                    data-id-item="${item.idItemCarrinho}"
                    data-id-produto="${item.idProduto}"
                    data-id-carrinho="${item.idCarrinho}">

                    <img class="itemImg" src="${corrigirImagem(item.produtoImagemUrl)}" />

                    <div class="itemInfo">
                        <h3 class="itemNome">${item.produtoNome}</h3>
                        <p class="itemPreco">${formatarValor(item.precoUnidadeCar)}</p>
                    </div>

                    <img class="itemDelete" src="/imgs/Icones/trash.svg" />

                    <div class="itemQuantidade">
                        <button class="quantBtn diminuir">-</button>
                        <span class="qtd">${item.qtdItemCar}</span>
                        <button class="quantBtn aumentar">+</button>
                    </div>
                </div>
            `;

            const adicionarEventos = () => {
                document.querySelectorAll(".aumentar").forEach(btn =>
                    btn.onclick = () => alterarQuantidade(btn, 1));

                document.querySelectorAll(".diminuir").forEach(btn =>
                    btn.onclick = () => alterarQuantidade(btn, -1));

                document.querySelectorAll(".itemDelete").forEach(btn =>
                    btn.onclick = removerItem);
            };

            const alterarQuantidade = async (botao, delta) => {
                const item = botao.closest(".itemCarrinho");
                const campoQtd = item.querySelector(".qtd");

                let novaQtd = Math.max(1, parseInt(campoQtd.textContent) + delta);

                await fetch("/ItemCarrinho/AlterarQuantidade", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({
                        idCarrinho: item.dataset.idCarrinho,
                        idProduto: item.dataset.idProduto,
                        qtd: novaQtd
                    })
                });

                carregarCarrinho();
            };

            const removerItem = async (ev) => {
                if (!confirm("Remover item do carrinho?")) return;

                const id = ev.target.closest(".itemCarrinho").dataset.idItem;

                await fetch("/ItemCarrinho/Remover", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ idItemCarrinho: id })
                });

                carregarCarrinho();
            };

            async function carregarCarrinho() {
                const resposta = await fetch(`/Carrinho/Buscar?idUsuario=${encodeURIComponent(idUsuario)}`);
                const dados = await resposta.json();

                //verifica se o carrinho possui itens
                if (!dados?.sucesso || !dados?.dados?.itens?.length) {
                    listaItens.innerHTML = `<div id="msg-vazio">Seu carrinho está vazio.</div>`;
                    campoSubtotal.textContent = formatarValor(0);
                    campoTotal.textContent = formatarValor(0);
                    currentCarrinhoId = null;
                    
                    showToast('Seu carrinho está vazio.', 3500, 'error');
                    return;
                }

                const itens = dados.dados.itens;
                const carrinho = dados.dados.carrinho || null;
                currentCarrinhoId = carrinho?.idCarrinho ?? carrinho?.IdCarrinho ?? null;

                
                listaItens.innerHTML = itens.map(criarItemHtml).join("");
                adicionarEventos();

                
                const subtotal = itens.reduce((soma, item) =>
                    soma + (item.subTotal ?? (item.precoUnidadeCar * item.qtdItemCar)), 0);

                campoSubtotal.textContent = formatarValor(subtotal);
                campoFrete.textContent = formatarValor(freteValor);
                campoTotal.textContent = formatarValor(subtotal + freteValor);
            }

            
            btnFinalizar.addEventListener('click', () => {
                if (!currentCarrinhoId) {
                    showToast('Carrinho inválido ou vazio.', 3000, 'error');
                    return;
                }
                modal.style.display = 'flex';
            });

            
            modalCancel.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            
            function populatePixDetails(randomKey) {
                
                const name = 'SONATTO';
                
                const part1 = String(Math.floor(Math.random() * 900) + 100);
                const part2 = String(Math.floor(Math.random() * 900) + 100);
                const cnpj = `•••.${part1}.${part2}-••`;
                const bankLine = 'Banco260 - Nu Pagamentos S.A. - Instituição de Pagamento';
                const identifier = Math.random().toString(36).slice(2, 12).toUpperCase();

                if (pixDetailsEl) {
                    pixDetailsEl.innerHTML = `
                        <div style="font-family:'Source Code Pro'; font-size:13px; color:#222; line-height:1.25;">
                            <div><strong>Nome:</strong> ${name}</div>
                            <div><strong>CNPJ:</strong> ${cnpj}</div>
                            <div style="margin-top:6px;">${bankLine}</div>
                            <div><strong>Identificador:</strong> ${identifier}</div>
                        </div>
                    `;
                }
            }
            modalSubmit.addEventListener('click', async () => {
                if (!currentCarrinhoId) {
                    showToast('Carrinho inválido.', 3000, 'error');
                    return;
                }

                const tipo = (tipoPagamentoEl.value || 'PIX').toUpperCase();

                
                if (tipo === 'CREDITO' || tipo === 'DEBITO') {
                    modal.style.display = 'none';
                    modal.setAttribute('aria-hidden', 'true');

                    
                    cartaoNome.value = '';
                    cartaoNum.value = '';
                    cartaoVal.value = '';
                    cartaoCvv.value = '';
                    [brandVisa, brandElo, brandMaster].forEach(b => b.classList.remove('active'));

                    modalCartao.style.display = 'flex';
                    modalCartao.setAttribute('aria-hidden', 'false');
                    cartaoNum.focus();
                    return;
                }

                // Se PIX, abrir modal PIX (gera chave, QR e detalhes); processamento apenas quando usuário tocar "Finalizar Compra"
                if (tipo === 'PIX') {
                    modal.style.display = 'none';
                    modal.setAttribute('aria-hidden', 'true');

                    pixCard?.classList.remove('processing');

                    const randomKey = 'PixChave_' + Math.random().toString(36).slice(2, 12).toUpperCase();
                    pixKeyEl.textContent = randomKey;

                    pixQrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(randomKey)}`;

                    populatePixDetails(randomKey);

                    if (pixCountdownEl) pixCountdownEl.style.display = 'none';
                    if (pixProcessingEl) { pixProcessingEl.style.display = 'none'; pixProcessingEl.innerHTML = '<div class="spinner" aria-hidden="true"></div><div class="processing-title">PROCESSANDO COMPRA</div>'; }
                    if (pixCompletedEl) pixCompletedEl.style.display = 'none';

                    
                    modalPix.style.display = 'flex';
                    modalPix.setAttribute('aria-hidden', 'false');

                    
                    document.body.style.overflow = 'hidden';

                    return;
                }

                
                modalSubmit.disabled = true;
                modalSubmit.textContent = 'Confirmando...';

                try {
                    const res = await fetch('/Venda/Gerar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ idUsuario: idUsuario, tipoPag: tipo, idCarrinho: currentCarrinhoId })
                    });

                    const result = await res.json();
                    if (result.sucesso) {
                        showToast(result.mensagem || 'Compra finalizada com sucesso.', 3500, 'success');
                        modal.style.display = 'none';
                        modal.setAttribute('aria-hidden', 'true');
                        carregarCarrinho();
                    } else {
                        showToast(result.mensagem || 'Erro ao finalizar compra.', 3500, 'error');
                    }
                } catch (err) {
                    console.error(err);
                    showToast('Erro na requisição ao finalizar.', 3500, 'error');
                } finally {
                    modalSubmit.disabled = false;
                    modalSubmit.textContent = 'Confirmar Compra';
                }
            });

            
            pixCopyBtn.addEventListener('click', async () => {
                const text = pixKeyEl.textContent || '';
                try {
                    await navigator.clipboard.writeText(text);
                    pixCopyBtn.classList.add('copied');
                    pixCopyBtn.textContent = 'Copiado';
                    setTimeout(() => {
                        pixCopyBtn.classList.remove('copied');
                        pixCopyBtn.textContent = 'Copiar chave';
                    }, 2200);
                    showToast('Chave copiada para a área de transferência.', 3000, 'success');
                } catch {
                    showToast('Não foi possível copiar.', 3000, 'error');
                }
            });

            
            pixOpenBtn.addEventListener('click', () => {
                const src = pixQrImg.src;
                window.open(src, '_blank');
            });

            
            pixFinalizar.addEventListener('click', async () => {
                if (!currentCarrinhoId) {
                    showToast('Carrinho inválido.', 3000, 'error');
                    return;
                }

                
                pixFinalizar.disabled = true;
                pixFinalizar.textContent = 'Processando...';

                
                pixCard?.classList.add('processing');
                if (pixProcessingEl) {
                    pixProcessingEl.innerHTML = '<div class="spinner" aria-hidden="true"></div><div class="processing-title">PROCESSANDO COMPRA</div>';
                    pixProcessingEl.style.display = 'flex';
                }
                if (pixCountdownEl) pixCountdownEl.style.display = 'none';
                if (pixCompletedEl) pixCompletedEl.style.display = 'none';

                
                setTimeout(async () => {
                    try {
                        const res = await fetch('/Venda/Gerar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: new URLSearchParams({
                                idUsuario: idUsuario,
                                tipoPag: 'PIX',
                                idCarrinho: currentCarrinhoId
                            })
                        });

                        const result = await res.json();
                        if (result?.sucesso) {
                            
                            if (pixProcessingEl) pixProcessingEl.style.display = 'none';
                            if (pixCompletedEl) pixCompletedEl.style.display = 'block';
                            
                            pixCard?.classList.remove('processing');
                            showToast(result.mensagem || 'Compra confirmada (PIX).', 3500, 'success');

                            
                            setTimeout(() => {
                                modalPix.style.display = 'none';
                                modalPix.setAttribute('aria-hidden', 'true');
                                document.body.style.overflow = '';
                                carregarCarrinho();
                            }, 900);
                        } else {
                            
                            if (pixProcessingEl) pixProcessingEl.style.display = 'none';
                            pixCard?.classList.remove('processing');
                            showToast(result?.mensagem || 'Erro ao registrar venda PIX.', 3500, 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        if (pixProcessingEl) pixProcessingEl.style.display = 'none';
                        pixCard?.classList.remove('processing');
                        showToast('Erro na requisição ao finalizar pagamento.', 3500, 'error');
                    } finally {
                        pixFinalizar.disabled = false;
                        pixFinalizar.textContent = 'Finalizar Compra';
                    }
                }, 7000);
            });

           
            modalCartao.addEventListener('click', (ev) => {
                if (ev.target === modalCartao) {
                    modalCartao.style.display = 'none';
                    modalCartao.setAttribute('aria-hidden', 'true');
                }
            });

            
            modalPix.addEventListener('click', (ev) => {
                if (ev.target === modalPix) {
                    modalPix.style.display = 'none';
                    modalPix.setAttribute('aria-hidden', 'true');
                    document.body.style.overflow = '';
                    
                    pixCard?.classList.remove('processing');
                }
            });

            // detectar bandeira e formatar numero (cartão)
            function normalizeNumberInput(v) {
                return v.replace(/\D/g, '');
            }

            function formatCardNumber(value) {
                const nums = normalizeNumberInput(value).slice(0, 19);
                // agrupa de 4 em 4
                return nums.match(/.{1,4}/g)?.join(' ') ?? nums;
            }

            function detectBrand(number) {
                const n = normalizeNumberInput(number);
                if (!n) return null;
                if (/^4/.test(n)) return 'visa';
                if (/^(5[1-5]|2[2-7])/.test(n)) return 'master';
                if (/^6(011|5|4[4-9])/.test(n)) return 'elo';
                return null;
            }

            cartaoNum.addEventListener('input', () => {
                const before = cartaoNum.value;
                const formatted = formatCardNumber(before);
                if (formatted !== before) cartaoNum.value = formatted;

                const brand = detectBrand(cartaoNum.value);
                [brandVisa, brandElo, brandMaster].forEach(b => b.classList.remove('active'));
                if (brand === 'visa') brandVisa.classList.add('active');
                if (brand === 'master') brandMaster.classList.add('active');
                if (brand === 'elo') brandElo.classList.add('active');
            });

            // máscara validade MM/AA
            cartaoVal.addEventListener('input', () => {
                let v = normalizeNumberInput(cartaoVal.value).slice(0, 4);
                if (v.length >= 3) v = v.slice(0,2) + '/' + v.slice(2);
                cartaoVal.value = v;
            });

            // permitir apenas números no CVV
            cartaoCvv.addEventListener('input', () => {
                cartaoCvv.value = normalizeNumberInput(cartaoCvv.value).slice(0,4);
            });

            // mostra erro estilizado e marca campos inválidos
            function showFieldError(message, fields = []) {
                cardErrorText.textContent = message;
                cardError.classList.add('show');
                fields.forEach(f => f.classList.add('invalid'));
                if (fields.length) fields[0].focus();
                clearTimeout(showFieldError._t);
                showFieldError._t = setTimeout(() => {
                    cardError.classList.remove('show');
                    fields.forEach(f => f.classList.remove('invalid'));
                }, 4000);
            }

            // finalizar pagamento pelo modal de cartão
            cartaoFinalizar.addEventListener('click', async () => {
                if (!currentCarrinhoId) {
                    showToast('Carrinho inválido.', 3000, 'error');
                    return;
                }

                // validações mínimas
                const nome = (cartaoNome.value || '').trim();
                const num = normalizeNumberInput(cartaoNum.value);
                const val = (cartaoVal.value || '').trim();
                const cvv = (cartaoCvv.value || '').trim();

                const invalids = [];
                if (!nome) invalids.push(cartaoNome);
                if (num.length < 13) invalids.push(cartaoNum);
                if (!/^\d{2}\/\d{2}$/.test(val)) invalids.push(cartaoVal);
                if (cvv.length < 3) invalids.push(cartaoCvv);

                if (invalids.length) {
                    showFieldError('Preencha corretamente os campos destacados.', invalids);
                    return;
                }

                cartaoFinalizar.disabled = true;
                cartaoFinalizar.textContent = 'Processando...';

                const tipo = (tipoPagamentoEl.value || 'CREDITO').toUpperCase();

                try {
                    const res = await fetch('/Venda/Gerar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            idUsuario: idUsuario,
                            tipoPag: tipo,
                            idCarrinho: currentCarrinhoId
                        })
                    });

                    const result = await res.json();
                    if (result.sucesso) {
                        modalCartao.style.display = 'none';
                        modalCartao.setAttribute('aria-hidden', 'true');
                        showToast(result.mensagem || 'Compra confirmada com cartão.', 3500, 'success');
                        carregarCarrinho();
                    } else {
                        showFieldError(result.mensagem || 'Erro ao processar pagamento.');
                    }
                } catch (err) {
                    console.error(err);
                    showFieldError('Erro na requisição ao finalizar pagamento.');
                } finally {
                    cartaoFinalizar.disabled = false;
                    cartaoFinalizar.textContent = 'Finalizar Compra →';
                }
            });

            
            function ensureToast(){
                if(!toast){
                    toast = document.getElementById('toast');
                }
                if(!toast){
                    toast = document.createElement('div');
                    toast.id = 'toast';
                    toast.className = 'toast';
                    toast.setAttribute('role','status');
                    toast.setAttribute('aria-live','polite');
                    toast.setAttribute('aria-atomic','true');
                    document.body.appendChild(toast);
                }
                return toast;
            }

            function showToast(message, timeout = 4000, type = 'default') {
                const t = ensureToast();
                t.textContent = message;
                t.style.background = type === 'success' ? '#0a7f6f' : (type === 'error' ? '#b00020' : '#222');
                t.classList.add('show');
                clearTimeout(t._t);
                t._t = setTimeout(() => t.classList.remove('show'), timeout);
            }

            
            window.notifyProductAdded = function (message) {
                showToast(message || 'Produto adicionado ao carrinho.', 3000, 'success');
            };

            carregarCarrinho();
        })();
    </script>

</body>
</html>