@using Sonatto.Models
@{
    Layout = null;
    var usuarioLogado = ViewBag.Usuario as Usuario;
    var historico = ViewBag.Acoes as IEnumerable<HistoricoAcao>;
}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sonatto</title>
    <link rel="stylesheet" href="~/css/Index.css" />
    <link rel="stylesheet" href="~/css/Funcionario.css" />
    <link href="~/imgs/Logos/Monografia.png" rel="shortcut icon" />
</head>
<body>
    @Html.Partial("_Header")

    <script>
        window.__niveis = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.Niveis ?? new List<string>()));
    </script>

    <div class="navDasPag">
        <a asp-controller="Home" asp-action="Index">Home &gt;</a>
        <a asp-controller="Usuario" asp-action="Perfil" style="color:black;">Perfil &gt;</a>
    </div>

    <div class="tituloLogOff">
        <h2>Bem vindo(a) de volta @(usuarioLogado?.Nome ?? "Usuario")</h2>
        <div class="logOff">
            <form asp-controller="Login" asp-action="Logout" method="post" style="display:inline;">
                @Html.AntiForgeryToken()
                <button type="submit" class="logOut" style="cursor:pointer; background:none; border:none; padding:0;">
                    <h4 style="display:inline;">Desconectar</h4>
                    <img src="~/imgs/icones/NTrheoXd.png" alt="Sair" />
                </button>
            </form>
        </div>
    </div>

    <div class="conteudo">
        <div class="painelDeControle">
            <p>Painel de controle</p>
            <div class="acoes">
                <a href="#" data-acao="ADICIONAR" class="adicionar">
                    <p>Adicionar Produto</p>
                    <img src="~/imgs/icones/Adicionar.svg" />
                    <p class="semPermissao" hidden>Requer Nível de acesso 1</p>
                    <img class="semPermissaoImg" src="~/imgs/icones/Bloqueado.svg" style="visibility: hidden; width: 0px;" />
                </a>

                <a href="#" data-acao="EDITAR" class="editar">
                    <p>Editar Produto</p>
                    <img src="~/imgs/icones/Editar.svg" />
                    <p class="semPermissao" hidden>Requer Nível de acesso 2</p>
                    <img class="semPermissaoImg" src="~/imgs/icones/Bloqueado.svg" style="visibility: hidden; width: 0px;" />
                </a>

                <a href="#" data-acao="DELETAR" class="deletar">
                    <p>Deletar Produto</p>
                    <img src="~/imgs/icones/Deletar.svg" />
                    <p class="semPermissao" hidden>Requer Nível de acesso 3</p>
                    <img class="semPermissaoImg" src="~/imgs/icones/Bloqueado.svg" style="visibility: hidden; width: 0px;"/>
                </a>
            </div>
        </div>
        <div class="historicoDeAcoes">
            <p>Seu histórico de ações</p>
            <div class="historico">
                @if (historico != null)
                {
                    foreach (var ac in historico)
                    {
                        <div class="acaoCard">
                            <img src="~/imgs/icones/Engranagem.svg" />
                            <div class="dadosAcao">
                                <h1>@ac.Acao</h1>
                                <div class="subDadosAcao">
                                    <p>Data: @ac.DataAcao.ToString("dd/MM/yyyy HH:mm")</p>
                                    <p>Nível: @ac.NomeNivel</p>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p>Nenhuma ação registrada.</p>
                }
            </div>
        </div>

    </div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const actions = document.querySelectorAll("[data-acao]");
        if (actions.length === 0) return;

        actions.forEach(el => {
            const acao = encodeURIComponent(el.dataset.acao);

            const atualizarUI = (allowed) => {
                const sem = el.querySelector(".semPermissao");
                const img = el.querySelector(".semPermissaoImg");

                el.classList.toggle("bloqueado", !allowed);
                el.dataset.allowed = allowed ? "1" : "0";

                if (sem) sem.hidden = allowed;
                if (img) {
                    img.style.visibility = allowed ? "hidden" : "visible";
                    img.style.width = allowed ? "0px" : "24px";
                }
            };

            // Checa permissão ao carregar
            fetch(`/Usuario/AcessarAcao?acao=${acao}`)
                .then(r => r.json())
                .then(j => atualizarUI(j?.allowed))
                .catch(() => atualizarUI(false)); // erro => bloquear

            // Clique sempre valida no servidor
            el.addEventListener("click", async e => {
                e.preventDefault();
                try {
                    const res = await fetch(`/Usuario/AcessarAcao?acao=${acao}`);
                    const j = await res.json();

                    if (j?.redirect) window.location.href = j.redirect;
                    else alert("Sem permissão para essa ação.");
                } catch {
                    window.location.href = "/Login";
                }
            });
        });
    });
    </script>



    @Html.Partial("_FooterSlim")
</body>
</html>
