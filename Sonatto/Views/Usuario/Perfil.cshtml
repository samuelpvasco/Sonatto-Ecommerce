@using System.Linq
@using Sonatto.Models
@using System.Text.Json
@model IEnumerable<Sonatto.Models.Produto>

@{
    Layout = null;
    var vendas = ViewBag.Vendas as IEnumerable<Venda> ?? Enumerable.Empty<Venda>();
    var itensPorVenda = ViewBag.ItensPorVenda as Dictionary<int, List<ItemVenda>> ?? new Dictionary<int, List<ItemVenda>>();
    var produtos = ViewBag.Produtos as IEnumerable<Produto> ?? Enumerable.Empty<Produto>();
    var usuarioLogado = ViewBag.Usuario as Usuario;
}

<!--chamar a lista de compras do usuario-->

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sonatto</title>
    <link rel="stylesheet" href="~/css/Index.css" />
    <link rel="stylesheet" href="~/css/Perfil.css" />
    <link href="~/imgs/Logos/Monografia.png" rel="shortcut icon" />
</head>
<body>
    @Html.Partial("_Header")

    <div class="navDasPag">
        <a asp-controller="Home" asp-action="Index">Home ></a>
        <a asp-controller="Usuario" asp-action="Perfil" style="color:black;">Perfil ></a>
    </div>

    <div class="tituloLogOff">
        <h2>Bem vindo(a) de volta @(usuarioLogado?.Nome ?? "Usuario")</h2>
        <div class="logOff">
            <form asp-controller="Login" asp-action="Logout" method="post" style="display:inline;">
                @Html.AntiForgeryToken()
                <button type="submit" class="logOut" style="cursor:pointer;">
                    <h4>Desconectar</h4>
                    <img src="~/imgs/icones/NTrheoXd.png" alt="Sair" />
                </button>
            </form>
        </div>
    </div>

    <!-- Ultimas compras (mantido) -->
    <div class="ultimasCompras">
        <div class="tituloBar">
            <h1>Suas últimas compras</h1>
            <img src="~/imgs/icones/seta-cima.svg" alt="Toggle" class="toggleBtn" id="seta" style="cursor: pointer;" aria-expanded="false" />
        </div>
        <div class="cards" id="cards">
            <div class="cardsDados">
                @foreach (var venda in vendas)
                {
                    var totalInvariant = venda.ValorTotal.ToString(System.Globalization.CultureInfo.InvariantCulture);
                    <div class="cardCompras" data-idvenda="@venda.IdVenda" data-total="@totalInvariant" style="cursor:pointer;">
                        <img src="~/imgs/icones/Sacola.svg" />
                        <div class="dadosCard">
                            <div class="dados">
                                <p class="dado">Data: @(venda.DataVenda is DateTime d ? d.ToString("dd/MM/yyyy") : "--/--/----")</p>
                                <p class="dado">Pagamento: @venda.TipoPag</p>
                                <p class="dado">Valor Total: R$ @venda.ValorTotal.ToString("N2", System.Globalization.CultureInfo.GetCultureInfo("pt-BR"))</p>
                            </div>
                            <p class="maisDetalhes">Clique para ver mais detalhes</p>
                        </div>
                    </div>
                }
            </div>

            <div class="dadosDaCompra">
                <h1>Dados da compra</h1>
                <div class="subCard">
                    <div class="grupo" id="itensCompraContainer">
                        @* Os itens vão aparecer por conta do script *@
                    </div>
                    <h2 class="valor" id="valorTotalCompra">Valor total: R$ 0,00</h2>
                </div>
            </div>
        </div>
    </div>

    @*Parte de Editar Conta*@
    <div class="editarConta">
        <div class="tituloBar">
            <h1>Editar Conta</h1>
            <img src="~/imgs/icones/seta-cima.svg" alt="Toggle" style="cursor: pointer;" class="toggleBtn" id="seta2"/>
        </div>

        <div class="conteudoEditar" id="editar">
            <p>Seus dados</p>
                <form asp-controller="Usuario" asp-action="Alterar" method="post" class="seusDadosCampo">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="IdUsuario" value="@(usuarioLogado?.IdUsuario ?? 0)" />

                    <div class="colunas">
                        <div class="coluna1">
                            <label>Nome</label>
                            <input name="Nome" type="text" value="@(usuarioLogado?.Nome ?? "")" placeholder="Nome do usuario" />
                            <label>Email</label>
                            <input name="Email" type="email" value="@(usuarioLogado?.Email ?? "")" placeholder="Email do usuario" />
                            <label>Senha</label>
                            <input name="Senha" type="password" value="@(usuarioLogado?.Senha ?? "")" placeholder="Senha do usuario" />
                        </div>

                        <div class="coluna2">
                            <label>Endereço</label>
                            <input name="Endereco" type="text" value="@(usuarioLogado?.Endereco ?? "")" placeholder="Digite seu endereço" />
                            <label>CPF</label>
                            <input name="CPF" type="text" maxlength="11" value="@(usuarioLogado?.CPF ?? "")" placeholder="CPF do usuario" />
                            <label>Telefone</label>
                            <input name="Telefone" type="tel" value="@(usuarioLogado?.Telefone ?? "")" placeholder="Telefone do usuario" />

                            
                        </div>

                        <div class="coluna3">
                            <p>Modifique apenas as informações que deseja alterar!</p>
                        </div>
                    </div>
                <div class="botoes">
                    <button type="button" class="btn-cancelar" id="btn-cancelar" onclick="location.reload()">Cancelar</button>
                    <button type="submit" class="btn-alterar" id="btn-alterar">Alterar</button>
                </div>
                    
                </form>

        </div>
    </div>

    @*Talvez você goste *@
    <div class="talvezVoceGoste">
        <div class="titulo-goste">
            <p class="talvezVoceGosteP">Talvez você goste</p>
        </div>
        <div class="produtos">
            @if (produtos != null && produtos.Any())
            {
                foreach (var produto in produtos.OrderBy(x => Guid.NewGuid()).Take(4))
                {
                    var imagem = (produto.UrlImagens != null && produto.UrlImagens.Any()) ? produto.UrlImagens[0] : Url.Content("~/imgs/placeholder.png");
                    <div class="exibicaoCard" data-avaliacao="@produto.Avaliacao.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)">
                        <img src="@imagem" class="exibicaoCardimg" />
                        <p class="cardNome">
                            @(produto.NomeProduto != null && produto.NomeProduto.Length > 20 ? produto.NomeProduto.Substring(0, 20) + "..." : produto.NomeProduto)
                        </p>
                        <div class="cardNotas">
                            <div class="rating-container">
                                <span class="star"></span>
                                <span class="star"></span>
                                <span class="star"></span>
                                <span class="star"></span>
                                <span class="star"></span>
                                <p class="cardNotasNota"><span>@produto.Avaliacao</span>/5</p>
                            </div>
                            <div class="cardPreco">
                                <strong>R$ @produto.Preco.ToString("N2", System.Globalization.CultureInfo.GetCultureInfo("pt-BR"))</strong>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <p>Nenhum produto encontrado.</p>
            }
        </div>
    </div>

    @*Script dos toggles*@
    <script>
        //setas
        const seta = document.getElementById("seta");
        const seta2 = document.getElementById("seta2")
        //conteudos
        const cards = document.getElementById("cards")
        const editar = document.getElementById("editar")
        var ativo = false;
        var ativo2 = false;
        
        seta.addEventListener("click", () => {
            if (!ativo) {
                cards.style.maxHeight = "700px";
                cards.style.opacity = "1";
                cards.style.pointerEvents = "auto";
                seta.classList.toggle("girar");
                ativo = true;
            } else {
                cards.style.margin="0"
                cards.style.maxHeight = "0";
                cards.style.opacity = "0";
                cards.style.pointerEvents = "none";
                seta.classList.toggle("girar");
                ativo = false;
            }
        });

        seta2.addEventListener("click", () => {
            if (!ativo2) {
                editar.style.maxHeight = "700px";
                editar.style.opacity = "1";
                editar.style.pointerEvents = "auto";
                seta2.classList.toggle("girar");
                ativo2 = true;
            } else {
                editar.style.margin="0"
                editar.style.maxHeight = "0";
                editar.style.opacity = "0";
                editar.style.pointerEvents = "none";
                seta2.classList.toggle("girar");
                ativo2 = false;
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cards = document.querySelectorAll('.exibicaoCard');

            cards.forEach(card => {

                const rating = parseFloat(card.getAttribute('data-avaliacao').replace(',', '.')) || 0;
                const stars = card.querySelectorAll('.star');

                stars.forEach((star, index) => {
                    const starValue = index + 1;

                    star.classList.remove('filled', 'half');

                    if (rating >= starValue) {
                        star.classList.add('filled');
                    } else if (rating >= starValue - 0.5) {
                        star.classList.add('half');
                    }
                });
            });
        });
    </script>

    <script>
        // Dados serializados do servidor
        const itensPorVenda = @Html.Raw(JsonSerializer.Serialize(itensPorVenda));
        const produtos = @Html.Raw(JsonSerializer.Serialize(produtos));

        const paraNumero = v => {
            if (v == null) return 0;
            if (typeof v === 'number') return isFinite(v) ? v : 0;
            return Number(String(v).replace(',', '.')) || 0;
        };
        const formatarBRL = v => paraNumero(v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // Mapa rápido de produtos por id
        const mapaProdutos = (() => {
            const m = new Map();
            if (!Array.isArray(produtos)) return m;
            produtos.forEach(p => m.set(String(p?.IdProduto ?? p?.idProduto ?? p?.Id ?? p?.id), p));
            return m;
        })();

        document.addEventListener('DOMContentLoaded', () => {
            const cartoes = document.querySelectorAll('.cardCompras');
            const container = document.getElementById('itensCompraContainer');
            const elementoTotal = document.getElementById('valorTotalCompra');
            if (!cartoes || !container || !elementoTotal) return;

            cartoes.forEach(cartao => {
                cartao.addEventListener('click', () => {
                    const idVenda = cartao.dataset.idvenda;
                    const itens = itensPorVenda?.[idVenda] ?? itensPorVenda?.[String(idVenda)] ?? [];

                    // Monta HTML dos itens
                    container.innerHTML = itens.map(item => {
                        const idProd = String(item?.IdProduto ?? item?.idProduto ?? item?.ProdutoId ?? item?.Id ?? item?.id ?? '');
                        const produto = mapaProdutos.get(idProd);
                        const nome = (produto?.NomeProduto ?? produto?.nomeProduto ?? item?.NomeProduto ?? item?.ProdutoNome ?? 'Produto').toString();
                        const qtd = paraNumero(item?.Qtd ?? item?.Quantidade ?? item?.qtd);
                        const subtotal = paraNumero(item?.SubTotal ?? item?.Subtotal ?? item?.subtotal ?? item?.PrecoUni ?? item?.Preco);

                        const nomeCurto = nome.length > 25 ? nome.slice(0, 25) + '...' : nome;
                        return `
                            <div class="itensDados">
                                <div class="dadosItemProduto">
                                    <p class="nome">${nomeCurto}</p>
                                    <p class="quantidade">Quantidade: ${qtd}</p>
                                </div>
                                <p class="subtotal">Subtotal: R$ ${formatarBRL(subtotal)}</p>
                            </div>`;
                    }).join('');

                    // Lê e mostra o total já calculado no servidor
                    const total = paraNumero(cartao.dataset.total);
                    elementoTotal.textContent = `Valor total: R$ ${formatarBRL(total)}`;
                });
            });
        });
    </script>

    @Html.Partial("_FooterSlim")
</body>
</html>
